<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CarbonIQ – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="css/theme.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg px-4 py-3 mb-4">
    <div class="d-flex align-items-center">
      <div class="logo-icon">
        <i class="fas fa-leaf"></i>
      </div>
      <a class="navbar-brand" href="#">CarbonIQ</a>
    </div>
    <div class="ms-auto">
      <span class="tag me-3" id="welcomeTag"></span>
      <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
    </div>
  </nav>
  <main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="page-title mb-0">Dashboard</h2>
      <div class="d-flex align-items-center">
        <span class="me-3">Your Carbon Grade:</span>
        <div class="grade-badge" id="userGradeBadge"></div>
        <small id="gradeDescription" class="ms-2"></small>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h5 class="card-title">Reports</h5>
          <p class="text-muted mb-3">Your calculated footprint over time.</p>
          <div class="kpi mb-3">
            <div><small class="text-muted">Latest total emission</small></div>
            <div id="latestEmission" class="kpi-value"></div>
          </div>
          <canvas id="emissionChart" height="150"></canvas>
          <button class="btn btn-primary w-100 mt-3" onclick="location.href='report.html'">View Reports</button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-icon">
            <i class="fas fa-running"></i>
          </div>
          <h5 class="card-title">Activities</h5>
          <p class="text-muted mb-3">Log daily actions and see their impact.</p>
          <div class="kpi mb-3">
            <div><small class="text-muted">Recent activities</small></div>
            <div id="recentActivities" class="small"></div>
          </div>
          <button class="btn btn-primary w-100" onclick="location.href='activity.html'">Add Activity</button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-4 h-100">
          <div class="card-icon">
            <i class="fas fa-lightbulb"></i>
          </div>
          <h5 class="card-title">Tips & Suggestions</h5>
          <p class="text-muted mb-3">Personalized ideas to reduce emissions.</p>
          <div id="tipsList"></div>
          <button class="btn btn-outline w-100 mt-3" onclick="location.href='suggestion.html'">Explore Actions</button>
        </div>
      </div>
    </div>
    <div class="row mt-4 g-4">
      <div class="col-md-6">
        <div class="card p-4">
          <h5 class="card-title">Weekly Comparison</h5>
          <p class="text-muted mb-3">Your emissions this week vs last week</p>
          <canvas id="weeklyComparisonChart" height="200"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4">
          <h5 class="card-title">Category Breakdown</h5>
          <p class="text-muted mb-3">Your emissions by category</p>
          <canvas id="categoryPieChart" height="200"></canvas>
        </div>
      </div>
    </div>
    <div class="row mt-4 g-4">
      <div class="col-md-8">
        <div class="card p-4">
          <h5 class="card-title">Emission Breakdown</h5>
          <p class="text-muted mb-3">Your emissions by category</p>
          <div id="categoryBreakdown"></div>
        </div>
      </div>
            <div class="col-md-4">
        <div class="card p-4">
          <h5 class="card-title">Quick Actions</h5>
          <p class="text-muted mb-3">Reduce your footprint faster</p>
          <div class="d-grid gap-2">
            <button class="btn btn-outline text-start" onclick="location.href='activity.html'">
              <i class="fas fa-plus me-2"></i> Log New Activity
            </button>
            <button class="btn btn-outline text-start" onclick="location.href='suggestion.html'">
              <i class="fas fa-lightbulb me-2"></i> Get Tips
            </button>
            <button class="btn btn-outline text-start" onclick="location.href='report.html'">
              <i class="fas fa-chart-bar me-2"></i> View Reports
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/api-config.js"></script>
  <script src="js/app.js"></script>
  <script>
    const user = requireAuth();
    function calculateWeeklyComparison(activities) {
      const now = new Date();
      const currentWeekStart = new Date(now.setDate(now.getDate() - now.getDay()));
      const lastWeekStart = new Date(currentWeekStart);
      lastWeekStart.setDate(lastWeekStart.getDate() - 7);
      
      const currentWeekEmissions = activities
        .filter(activity => new Date(activity.date) >= currentWeekStart)
        .reduce((sum, activity) => sum + activity.co2, 0);
      
      const lastWeekEmissions = activities
        .filter(activity => {
          const activityDate = new Date(activity.date);
          return activityDate >= lastWeekStart && activityDate < currentWeekStart;
        })
        .reduce((sum, activity) => sum + activity.co2, 0);
      
      return {
        current: currentWeekEmissions,
        last: lastWeekEmissions,
        change: ((currentWeekEmissions - lastWeekEmissions) / lastWeekEmissions * 100) || 0
      };
    }

    (async function init() {
      document.getElementById('welcomeTag').textContent = `Hello, ${user.name}`;
      const gradeInfo = await API.getUserGrade(user.id);
      const gradeBadge = document.getElementById('userGradeBadge');
      gradeBadge.className = `grade-badge grade-${gradeInfo.grade.toLowerCase()}`;
      gradeBadge.textContent = gradeInfo.grade;
      document.getElementById('gradeDescription').textContent = gradeInfo.description;
      const reports = await API.getReportsByUser(user.id);
      const latest = reports.at(-1);
      document.getElementById('latestEmission').textContent = latest ? `${latest.total_emission} kg CO2e` : 'No reports';
      const ctx = document.getElementById('emissionChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: reports.map(r => r.date),
          datasets: [{
            label: 'Emissions (kg CO2e)',
            data: reports.map(r => r.total_emission),
            borderColor: '#22c55c',
            backgroundColor: 'rgba(34, 197, 92, 0.2)',
            tension: 0.3,
            fill: true,
            pointBackgroundColor: '#93e9a9'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#ecf4ef' } }
          },
          scales: {
            x: { 
              ticks: { color: '#ecf4ef' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: { 
              ticks: { color: '#ecf4ef' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
      const activities = await API.getActivitiesByUser(user.id);
      const recent = activities.slice(-3).map(a => {
        const category = MockDB.categories.find(c => c.id === a.category_id);
        return `• ${a.name} (${a.co2} kg)`;
      }).join('<br>');
      document.getElementById('recentActivities').innerHTML = recent || 'No activity yet';
      const tips = await API.getPersonalizedTips(user.id);
      document.getElementById('tipsList').innerHTML = tips.slice(0, 3).map(t => {
        const category = MockDB.categories.find(c => c.id === t.category_id);
        return `
          <div class="suggestion-item">
            <span class="tag me-2">${category.name}</span>
            <span class="tip-level level-${t.level}">${t.level}</span>
            <div class="small mt-1">${t.text}</div>
          </div>
        `;
      }).join('') || '<div class="text-muted">No personalized tips yet. Add activities to get suggestions.</div>';
      const weeklyData = calculateWeeklyComparison(activities);
      const weeklyCtx = document.getElementById('weeklyComparisonChart').getContext('2d');
      new Chart(weeklyCtx, {
        type: 'bar',
        data: {
          labels: ['Last Week', 'This Week'],
          datasets: [{
            label: 'Emissions (kg CO2e)',
            data: [weeklyData.last, weeklyData.current],
            backgroundColor: [
              'rgba(156, 163, 175, 0.8)',
              'rgba(34, 197, 92, 0.8)'
            ],
            borderColor: [
              'rgb(156, 163, 175)',
              'rgb(34, 197, 92)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#ecf4ef' } },
            tooltip: { callbacks: { label: (context) => `${context.parsed.y.toFixed(1)} kg CO2e` } }
          },
          scales: {
            x: { 
              ticks: { color: '#ecf4ef' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: { 
              ticks: { color: '#ecf4ef' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
      const categoryData = calculateCategoryBreakdown(activities);
      const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: categoryData.map(item => item.name),
          datasets: [{
            data: categoryData.map(item => item.emissions),
            backgroundColor: [
              '#22c55c', '#a3e635', '#facc15', '#fb923c', '#ef4444',
              '#c084fc', '#06b6d4', '#f97316', '#8b5cf6', '#10b981'
            ],
            borderColor: 'var(--bg)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { color: '#ecf4ef', padding: 15 }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value.toFixed(1)} kg (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      document.getElementById('categoryBreakdown').innerHTML = categoryData.map(item => `
        <div class="category-card">
          <div class="d-flex align-items-center">
            <div class="category-icon">
              <i class="fas ${item.icon}"></i>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between">
                <span>${item.name}</span>
                <span class="kpi-value">${item.emissions.toFixed(1)} kg</span>
              </div>
              <div class="progress mt-2">
                <div class="progress-bar" role="progressbar" style="width: ${item.percentage}%"></div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    })();

    function calculateCategoryBreakdown(activities) {
      const categoryEmissions = {};
      let totalEmissions = 0;
      
      activities.forEach(activity => {
        if (!categoryEmissions[activity.category_id]) {
          categoryEmissions[activity.category_id] = 0;
        }
        categoryEmissions[activity.category_id] += activity.co2;
        totalEmissions += activity.co2;
      });

      return Object.keys(categoryEmissions).map(catId => {
        const category = MockDB.categories.find(c => c.id === parseInt(catId));
        const emissions = categoryEmissions[catId];
        const percentage = totalEmissions > 0 ? (emissions / totalEmissions) * 100 : 0;
        
        return {
          id: parseInt(catId),
          name: category.name,
          icon: category.icon,
          emissions: emissions,
          percentage: percentage
        };
      });
    }
  </script>
</body>
</html>