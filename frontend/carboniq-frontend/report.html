<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CarbonIQ – Reports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="css/theme.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <nav class="navbar px-4 py-3 mb-4">
    <div class="d-flex align-items-center">
      <div class="logo-icon">
        <i class="fas fa-leaf"></i>
      </div>
      <a class="navbar-brand" href="dashboard.html">CarbonIQ</a>
    </div>
    <div class="ms-auto">
      <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
    </div>
  </nav>

  <main class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <h2 class="page-title mb-0">Your Reports</h2>
      <div class="d-flex gap-2">
        <input class="form-control input-control" id="reportSearch" placeholder="Search activities...">
        <button class="btn btn-primary" onclick="downloadAllReportsPDF()">
          <i class="fas fa-download me-2"></i>Export All
        </button>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <div class="card-icon mx-auto">
            <i class="fas fa-list"></i>
          </div>
          <h5 id="totalActivities" class="kpi-value">0</h5>
          <small class="text-muted">Total Activities</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <div class="card-icon mx-auto">
            <i class="fas fa-cloud"></i>
          </div>
          <h5 id="totalEmissions" class="kpi-value">0 kg</h5>
          <small class="text-muted">Total Emissions</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <div class="card-icon mx-auto">
            <i class="fas fa-calendar"></i>
          </div>
          <h5 id="timePeriod" class="kpi-value">-</h5>
          <small class="text-muted">Time Period</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3 text-center">
          <div class="card-icon mx-auto">
            <i class="fas fa-chart-line"></i>
          </div>
          <h5 id="averageDaily" class="kpi-value">0 kg</h5>
          <small class="text-muted">Average Daily</small>
        </div>
      </div>
    </div>

    <div class="card p-4">
      <div class="table-responsive">
        <table class="table" id="reportTable">
          <thead>
            <tr>
              <th>Activity</th>
              <th>Category</th>
              <th>Date</th>
              <th>Quantity</th>
              <th>Emission</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="emptyState" class="text-center py-5" style="display:none;">
        <div class="card-icon mx-auto mb-3">
          <i class="fas fa-inbox"></i>
        </div>
        <h5>No reports found</h5>
        <p class="text-muted">Start by adding activities to see your reports here.</p>
        <button class="btn btn-primary" onclick="location.href='activity.html'">
          <i class="fas fa-plus me-2"></i>Add Your First Activity
        </button>
      </div>
    </div>
  </main>

  <script src="js/app.js"></script>
  <script src="js/api-config.js"></script>
  <script>
    const user = requireAuth();
    let rowsCache = [];
    let allActivities = [];

    async function loadReports() {
      allActivities = await API.getActivitiesByUser(user.id);
      const tbody = document.querySelector('#reportTable tbody');

      document.getElementById('totalActivities').textContent = allActivities.length;
      const totalEmissions = allActivities.reduce((sum, a) => sum + a.co2, 0);
      document.getElementById('totalEmissions').textContent = `${totalEmissions.toFixed(1)} kg`;
      
      if (allActivities.length > 0) {
        const dates = allActivities.map(a => new Date(a.date)).sort((a, b) => a - b);
        const start = dates[0].toLocaleDateString();
        const end = dates[dates.length - 1].toLocaleDateString();
        document.getElementById('timePeriod').textContent = dates[0].getTime() === dates[dates.length - 1].getTime() ? start : `${start} - ${end}`;
        
        const days = Math.max(1, (dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24) + 1);
        document.getElementById('averageDaily').textContent = `${(totalEmissions / days).toFixed(1)} kg`;
      }

      tbody.innerHTML = allActivities.map(a => {
        const category = MockDB.categories.find(c => c.id === a.category_id)?.name || 'Unknown';
        return `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="category-icon me-2">
                  <i class="fas ${MockDB.categories.find(c => c.id === a.category_id)?.icon || 'fa-circle'}"></i>
                </div>
                <div>${a.name}</div>
              </div>
            </td>
            <td><span class="tag">${category}</span></td>
            <td>${a.date}</td>
            <td>${a.quantity} ${a.unit}</td>
            <td><strong>${a.co2} kg</strong></td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline" onclick="downloadReportCSV(${a.id})" title="Download CSV">
                  <i class="fas fa-file-csv"></i>
                </button>
                <button class="btn btn-outline" onclick="downloadReportPDF(${a.id})" title="Download PDF">
                  <i class="fas fa-file-pdf"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      rowsCache = Array.from(tbody.querySelectorAll('tr'));
      document.getElementById('emptyState').style.display = allActivities.length ? 'none' : 'block';
      document.getElementById('reportTable').style.display = allActivities.length ? '' : 'none';
    }

    document.getElementById('reportSearch').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      let visible = 0;
      rowsCache.forEach(tr => {
        const match = tr.innerText.toLowerCase().includes(q);
        tr.style.display = match ? '' : 'none';
        if (match) visible++;
      });
      document.getElementById('emptyState').style.display = visible ? 'none' : 'block';
      document.getElementById('reportTable').style.display = visible ? '' : 'none';
    });

    function downloadReportCSV(activityId) {
      const a = MockDB.activities.find(act => act.id === activityId);
      const category = MockDB.categories.find(c => c.id === a.category_id)?.name || 'Unknown';

      const content = `Report ID,Activity,Category,Date,Quantity,Unit,Emission (kg CO2e)\n${a.id},${a.name},${category},${a.date},${a.quantity},${a.unit},${a.co2}`;
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `carbon_report_${a.id}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function downloadReportPDF(activityId) {
      const act = MockDB.activities.find(a => a.id === activityId);
      const category = MockDB.categories.find(c => c.id === act.category_id)?.name || 'Unknown';

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.setTextColor(34, 197, 92);
      doc.text("CarbonIQ Activity Report", 20, 20);

      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text(`Activity: ${act.name}`, 20, 40);
      doc.text(`Category: ${category}`, 20, 50);
      doc.text(`Date: ${act.date}`, 20, 60);
      doc.text(`Quantity: ${act.quantity} ${act.unit}`, 20, 70);
      doc.text(`Emission: ${act.co2} kg CO2e`, 20, 80);

      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text("Generated by CarbonIQ – Sustainable Living Tracker", 20, doc.internal.pageSize.height - 10);

      doc.save(`carbon_report_${act.id}.pdf`);
    }

    function downloadAllReportsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.setTextColor(34, 197, 92);
      doc.text("CarbonIQ Complete Report", 20, 20);

      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text(`Generated for: ${user.name}`, 20, 40);
      doc.text(`Total Activities: ${allActivities.length}`, 20, 50);
      const totalEmissions = allActivities.reduce((sum, a) => sum + a.co2, 0);
      doc.text(`Total Emissions: ${totalEmissions.toFixed(1)} kg CO2e`, 20, 60);
      doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 20, 70);

      const tableData = allActivities.map(a => {
        const category = MockDB.categories.find(c => c.id === a.category_id)?.name || 'Unknown';
        return [a.name, category, a.date, `${a.quantity} ${a.unit}`, `${a.co2} kg`];
      });

      doc.autoTable({
        startY: 80,
        head: [['Activity', 'Category', 'Date', 'Quantity', 'Emission']],
        body: tableData,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [34, 197, 92] }
      });

      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text("Generated by CarbonIQ – Track, learn, and reduce your footprint", 20, finalY);

      doc.save(`carbon_complete_report_${user.username}.pdf`);
    }

    loadReports();
  </script>
</body>
</html>