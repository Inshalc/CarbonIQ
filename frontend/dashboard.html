<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CarbonIQ ‚Äì Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="css/theme.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Just minor spacing optimizations without breaking layout */
    .optimized-card {
      margin-bottom: 0;
    }
    .optimized-content {
      padding: 1rem;
    }
    .compact-list {
      max-height: 220px;
      overflow-y: auto;
    }
    .compact-list .activity-item,
    .compact-list .suggestion-item {
      padding: 0.6rem;
      margin-bottom: 0.5rem;
    }
    .stats-card {
      padding: 1rem;
    }
    .stats-card .kpi-value {
      margin-bottom: 0.25rem;
    }
    .equal-height {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .equal-height .card-body {
      flex: 1;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg px-4 py-3 mb-3">
    <div class="d-flex align-items-center">
      <div class="logo-icon">
        <i class="fas fa-leaf"></i>
      </div>
      <a class="navbar-brand" href="#">CarbonIQ</a>
    </div>
    <div class="ms-auto">
      <span class="tag me-3" id="welcomeTag"></span>
      <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
    </div>
  </nav>
  
  <main class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="page-title mb-0">Dashboard</h2>
      <div class="d-flex align-items-center">
        <span class="me-3">Your Carbon Grade:</span>
        <div class="grade-badge" id="userGradeBadge">B</div>
        <small id="gradeDescription" class="ms-2">Good effort!</small>
      </div>
    </div>

    <!-- Stats Cards - Just reduced padding -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card stats-card text-center">
          <div class="card-icon">
            <i class="fas fa-list"></i>
          </div>
          <h5 id="totalActivities" class="kpi-value">0</h5>
          <small class="text-muted">Total Activities</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card text-center">
          <div class="card-icon">
            <i class="fas fa-cloud"></i>
          </div>
          <h5 id="totalEmissions" class="kpi-value">0 kg</h5>
          <small class="text-muted">Total Emissions</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card text-center">
          <div class="card-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h5 id="averageDaily" class="kpi-value">0 kg</h5>
          <small class="text-muted">Average Daily</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card stats-card text-center">
          <div class="card-icon">
            <i class="fas fa-bullseye"></i>
          </div>
          <h5 id="savings" class="kpi-value">0%</h5>
          <small class="text-muted">vs Last Week</small>
        </div>
      </div>
    </div>

    <!-- Top Row: Weekly Trend, Recent Activities, Tips & Suggestions -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card optimized-card h-100">
          <div class="optimized-content">
            <div class="card-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <h5 class="card-title">Weekly Trend</h5>
            <p class="text-muted mb-3">Your emissions over the past week</p>
            <canvas id="weeklyChart" height="200"></canvas>
            <button class="btn btn-primary w-100 mt-3" onclick="location.href='report.html'">View Reports</button>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card optimized-card h-100">
          <div class="optimized-content">
            <div class="card-icon">
              <i class="fas fa-running"></i>
            </div>
            <h5 class="card-title">Recent Activities</h5>
            <p class="text-muted mb-3">Your latest logged activities</p>
            <div id="recentActivities" class="small compact-list">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Loading activities...
              </div>
            </div>
            <button class="btn btn-primary w-100 mt-3" onclick="location.href='activity.html'">Add Activity</button>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card optimized-card h-100">
          <div class="optimized-content">
            <div class="card-icon">
              <i class="fas fa-lightbulb"></i>
            </div>
            <h5 class="card-title">Tips & Suggestions</h5>
            <p class="text-muted mb-3">Personalized ideas to reduce emissions</p>
            <div id="suggestions" class="compact-list">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Loading suggestions...
              </div>
            </div>
            <button class="btn btn-outline w-100 mt-3" onclick="location.href='suggestion.html'">Explore Actions</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Second Row: Detailed Category Breakdown and Quick Actions (equal height) -->
    <div class="row g-3 mb-4">
      <div class="col-md-8">
        <div class="card equal-height">
          <div class="card-body optimized-content">
            <h5 class="card-title">Detailed Category Breakdown</h5>
            <p class="text-muted mb-3">Your emissions by category with progress bars</p>
            <div id="categoryBreakdown">
              <div class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin"></i> Loading category breakdown...
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card equal-height">
          <div class="card-body optimized-content">
            <h5 class="card-title">Quick Actions</h5>
            <p class="text-muted mb-3">Reduce your footprint faster</p>
            <div class="d-grid gap-2">
              <button class="btn btn-outline text-start" onclick="location.href='activity.html'">
                <i class="fas fa-plus me-2"></i> Log New Activity
              </button>
              <button class="btn btn-outline text-start" onclick="location.href='suggestion.html'">
                <i class="fas fa-lightbulb me-2"></i> Get Tips
              </button>
              <button class="btn btn-outline text-start" onclick="location.href='report.html'">
                <i class="fas fa-chart-bar me-2"></i> View Reports
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Third Row: Weekly Comparison and Category Breakdown -->
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card optimized-card">
          <div class="optimized-content">
            <h5 class="card-title">Weekly Comparison</h5>
            <p class="text-muted mb-3">Your emissions this week vs last week</p>
            <canvas id="weeklyComparisonChart" height="200"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card optimized-card">
          <div class="optimized-content">
            <h5 class="card-title">Category Breakdown</h5>
            <p class="text-muted mb-3">Your emissions by category</p>
            <canvas id="categoryChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Your original JavaScript remains completely unchanged -->
  <script src="js/app.js"></script>
  <script>
    class DashboardManager {
      constructor() {
        this.charts = {};
        this.categories = [
          { category_id: 1, name: 'Transportation', icon: 'fa-car' },
          { category_id: 2, name: 'Diet', icon: 'fa-utensils' },
          { category_id: 3, name: 'Energy', icon: 'fa-bolt' },
          { category_id: 4, name: 'Shopping', icon: 'fa-shopping-bag' },
          { category_id: 5, name: 'Waste', icon: 'fa-recycle' },
          { category_id: 6, name: 'Water Use', icon: 'fa-tint' },
          { category_id: 7, name: 'Travel', icon: 'fa-plane' },
          { category_id: 8, name: 'Work/Office', icon: 'fa-briefcase' },
          { category_id: 9, name: 'Home', icon: 'fa-home' },
          { category_id: 10, name: 'Community', icon: 'fa-users' }
        ];
        this.init();
      }

      async init() {
        console.log('üöÄ Initializing dashboard...');
        await this.checkAuth();
        await this.loadDashboardData();
        
        // Run debug to see what data we're getting
        setTimeout(() => this.debugAPIs(), 1000);
      }

      async checkAuth() {
        try {
          const user = await requireAuth();
          if (user) {
            document.getElementById('welcomeTag').textContent = `Hello, ${user.first_name || user.username}!`;
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          window.location.href = 'index.html';
        }
      }

      async loadDashboardData() {
        try {
          console.log('üìä Loading dashboard data...');
          
          // Load all data with proper error handling
          const activities = await this.safeLoad(() => API.getActivities(), 'activities', []);
          const emissionsSummary = await this.safeLoad(() => API.getEmissionsSummary(), 'emissions summary', this.getDefaultEmissionsSummary());
          const suggestionsData = await this.safeLoad(() => API.getSuggestions(), 'suggestions', { suggestions: [] });

          console.log('üì¶ Loaded data:', {
            activities: activities.length,
            emissionsSummary,
            suggestions: suggestionsData.suggestions?.length || 0
          });

          this.updateStats(activities, emissionsSummary);
          this.createCharts(emissionsSummary, activities);
          this.displayRecentActivities(activities);
          this.displaySuggestions(suggestionsData);
          this.displayCategoryBreakdown(emissionsSummary);

        } catch (error) {
          console.error('‚ùå Failed to load dashboard data:', error);
          this.showError('Failed to load dashboard data: ' + error.message);
        }
      }

      async safeLoad(apiCall, name, defaultValue) {
        try {
          console.log(`üì• Loading ${name}...`);
          const result = await apiCall();
          console.log(`‚úÖ ${name} loaded:`, result);
          return result;
        } catch (error) {
          console.error(`‚ùå Failed to load ${name}:`, error);
          return defaultValue;
        }
      }

      getDefaultEmissionsSummary() {
        return {
          weekly_trend: [],
          by_category: [],
          total_emission: 0
        };
      }

      updateStats(activities, emissionsSummary) {
        console.log('üìà Updating stats...');
        
        // Safely parse total_emission
        const totalEmission = this.safeParseFloat(emissionsSummary.total_emission);
        
        // Total Activities
        this.updateElement('totalActivities', activities.length.toString());
        
        // Total Emissions
        this.updateElement('totalEmissions', `${totalEmission.toFixed(1)} kg`);
        
        // Average Daily
        if (activities.length > 0) {
          const uniqueDays = new Set(activities.map(a => a.start_date?.split('T')[0]).filter(Boolean)).size;
          const avgDaily = totalEmission / Math.max(1, uniqueDays);
          this.updateElement('averageDaily', `${avgDaily.toFixed(1)} kg`);
        } else {
          this.updateElement('averageDaily', '0 kg');
        }
        
        // Savings (placeholder)
        this.updateElement('savings', '-5.2%', true);
      }

      updateElement(id, value, isSavings = false) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
          if (isSavings) {
            element.style.color = value.startsWith('+') ? '#28a745' : '#dc3545';
          }
        }
      }

      safeParseFloat(value) {
        if (value === null || value === undefined) return 0;
        const parsed = parseFloat(value);
        return isNaN(parsed) ? 0 : parsed;
      }

      createCharts(emissionsSummary, activities) {
        console.log('üìä Creating charts...');
        
        this.createWeeklyChart(emissionsSummary.weekly_trend || []);
        this.createCategoryChart(emissionsSummary.by_category || []);
        this.createWeeklyComparisonChart(activities);
      }

      createWeeklyChart(weeklyTrend) {
        const ctx = document.getElementById('weeklyChart');
        if (!ctx) {
          console.log('‚ùå Weekly chart canvas not found');
          return;
        }

        if (weeklyTrend.length === 0) {
          console.log('üìä No weekly trend data for chart');
          this.showNoDataMessage(ctx, 'No weekly data available');
          return;
        }

        const labels = weeklyTrend.map(item => {
          try {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { weekday: 'short' });
          } catch (e) {
            return 'Unknown';
          }
        });
        
        const data = weeklyTrend.map(item => this.safeParseFloat(item.daily_emission));

        // Destroy existing chart if it exists
        if (this.charts.weekly) {
          this.charts.weekly.destroy();
        }

        this.charts.weekly = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Daily Emissions (kg CO‚ÇÇ)',
              data: data,
              borderColor: '#22c55c',
              backgroundColor: 'rgba(34, 197, 92, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { 
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      createCategoryChart(categoryData) {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) {
          console.log('‚ùå Category chart canvas not found');
          return;
        }

        if (categoryData.length === 0) {
          console.log('üìä No category data for chart');
          this.showNoDataMessage(ctx, 'No category data available');
          return;
        }

        const labels = categoryData.map(item => item.category_name);
        const data = categoryData.map(item => this.safeParseFloat(item.total_emission));

        if (this.charts.category) {
          this.charts.category.destroy();
        }

        this.charts.category = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: [
                '#667eea', '#764ba2', '#f093fb', '#4ecdc4', '#ff6b6b', '#ffd93d',
                '#c084fc', '#06b6d4', '#f97316', '#8b5cf6'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { 
                position: 'bottom'
              }
            }
          }
        });
      }

      createWeeklyComparisonChart(activities) {
        const ctx = document.getElementById('weeklyComparisonChart');
        if (!ctx) {
          console.log('‚ùå Weekly comparison chart canvas not found');
          return;
        }

        const weeklyData = this.calculateWeeklyComparison(activities);

        if (this.charts.weeklyComparison) {
          this.charts.weeklyComparison.destroy();
        }

        this.charts.weeklyComparison = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Last Week', 'This Week'],
            datasets: [{
              label: 'Emissions (kg CO‚ÇÇ)',
              data: [weeklyData.last, weeklyData.current],
              backgroundColor: [
                'rgba(156, 163, 175, 0.8)',
                'rgba(34, 197, 92, 0.8)'
              ],
              borderColor: [
                'rgb(156, 163, 175)',
                'rgb(34, 197, 92)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      showNoDataMessage(canvas, message) {
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#6c757d';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
      }

      calculateWeeklyComparison(activities) {
        const now = new Date();
        const currentWeekStart = new Date(now);
        currentWeekStart.setDate(now.getDate() - now.getDay());
        currentWeekStart.setHours(0, 0, 0, 0);
        
        const lastWeekStart = new Date(currentWeekStart);
        lastWeekStart.setDate(lastWeekStart.getDate() - 7);

        const currentWeekEmissions = activities
          .filter(activity => {
            try {
              const activityDate = new Date(activity.start_date);
              return activityDate >= currentWeekStart;
            } catch (e) {
              return false;
            }
          })
          .reduce((sum, activity) => sum + this.safeParseFloat(activity.CO2_result), 0);

        const lastWeekEmissions = activities
          .filter(activity => {
            try {
              const activityDate = new Date(activity.start_date);
              return activityDate >= lastWeekStart && activityDate < currentWeekStart;
            } catch (e) {
              return false;
            }
          })
          .reduce((sum, activity) => sum + this.safeParseFloat(activity.CO2_result), 0);

        return {
          current: currentWeekEmissions,
          last: lastWeekEmissions
        };
      }

      displayRecentActivities(activities) {
        const container = document.getElementById('recentActivities');
        if (!container) return;

        if (activities.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-inbox fa-2x mb-2"></i>
              <p>No activities yet</p>
              <small>Start by adding your first activity!</small>
            </div>
          `;
          return;
        }

        const recentActivities = activities.slice(0, 5);
        const html = recentActivities.map(activity => {
          const category = this.categories.find(cat => cat.category_id === activity.category_id);
          const co2 = this.safeParseFloat(activity.CO2_result);
          
          return `
            <div class="activity-item mb-2 p-2 border rounded">
              <div class="d-flex justify-content-between align-items-center">
                <strong class="small">${activity.activity_name || 'Unnamed Activity'}</strong>
                <span class="badge bg-primary">${co2.toFixed(1)} kg</span>
              </div>
              <div class="d-flex justify-content-between text-muted small">
                <span>${category?.name || 'Unknown'}</span>
                <span>${new Date(activity.start_date).toLocaleDateString()}</span>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
      }

      displaySuggestions(suggestionsData) {
        const container = document.getElementById('suggestions');
        if (!container) return;

        const suggestions = suggestionsData.suggestions || [];
        
        if (suggestions.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-lightbulb fa-2x mb-2"></i>
              <p>No suggestions yet</p>
              <small>Add more activities to get personalized tips!</small>
            </div>
          `;
          return;
        }

        const html = suggestions.map(suggestion => `
          <div class="suggestion-item mb-3 p-3 border rounded">
            <h6 class="mb-2">${suggestion.title}</h6>
            <p class="small text-muted mb-0">${suggestion.description}</p>
          </div>
        `).join('');

        container.innerHTML = html;
      }

      displayCategoryBreakdown(emissionsSummary) {
        const container = document.getElementById('categoryBreakdown');
        if (!container) return;

        const categoryData = emissionsSummary.by_category || [];
        const totalEmission = this.safeParseFloat(emissionsSummary.total_emission);
        const totalEmissions = totalEmission > 0 ? totalEmission : 1; // Avoid division by zero

        if (categoryData.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="fas fa-chart-pie fa-2x mb-2"></i>
              <p>No category data yet</p>
              <small>Add activities to see breakdown</small>
            </div>
          `;
          return;
        }

        const html = categoryData.map(item => {
          const emission = this.safeParseFloat(item.total_emission);
          const percentage = totalEmissions > 0 ? (emission / totalEmissions) * 100 : 0;
          const category = this.categories.find(cat => cat.name === item.category_name);
          
          return `
            <div class="category-item mb-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small">
                  <i class="fas ${category?.icon || 'fa-circle'} me-2"></i>
                  ${item.category_name}
                </span>
                <span class="small fw-bold">${emission.toFixed(1)} kg</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: ${percentage}%; background-color: #22c55d;"></div>
              </div>
              <div class="text-end small text-muted mt-1">${percentage.toFixed(1)}%</div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
      }

      async debugAPIs() {
        console.log('üîç Debugging API endpoints...');
        
        try {
          // Test activities endpoint
          console.log('üì• Testing activities endpoint...');
          const activities = await API.getActivities();
          console.log('‚úÖ Activities:', activities);
          
          // Test emissions summary endpoint
          console.log('üì• Testing emissions summary endpoint...');
          const emissionsSummary = await API.getEmissionsSummary();
          console.log('‚úÖ Emissions Summary:', emissionsSummary);
          console.log('‚úÖ total_emission type:', typeof emissionsSummary.total_emission);
          console.log('‚úÖ total_emission value:', emissionsSummary.total_emission);
          
          // Test suggestions endpoint
          console.log('üì• Testing suggestions endpoint...');
          const suggestions = await API.getSuggestions();
          console.log('‚úÖ Suggestions:', suggestions);
          
        } catch (error) {
          console.error('‚ùå API debug failed:', error);
        }
      }

      showError(message) {
        console.error('Dashboard error:', message);
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('main').prepend(alertDiv);
      }
    }

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üè† DOM loaded, initializing dashboard...');
      window.dashboardManager = new DashboardManager();
    });
  </script>
</body>
</html>